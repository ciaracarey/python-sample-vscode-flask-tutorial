name: Python CI (uv + Cloudsmith)

on:
  push:          { branches: ["main"] }
  pull_request:  { branches: ["main"] }
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write      # Cloudsmith OIDC

env:
  CS_ORG:  globex-innovations
  CS_REPO: future-nonprod
  SERVICE: ci_future_service

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # 1. OIDC â†’ $CLOUDSMITH_API_KEY
    - name: Cloudsmith login (OIDC)
      uses: cloudsmith-io/cloudsmith-cli-action@v1.0.2
      with:
        oidc-namespace:    ${{ env.CS_ORG }}
        oidc-service-slug: ${{ env.SERVICE }}
        oidc-auth-only:    "true"

    # 2. Export index variables
    - name: Export Cloudsmith indexes
      run: |
        CS_PY_INDEX="https://token:${CLOUDSMITH_API_KEY}@dl.cloudsmith.io/basic/${{ env.CS_ORG }}/${{ env.CS_REPO }}/python/simple/"
        {
          echo "PIP_INDEX_URL=${CS_PY_INDEX}"
          echo "UV_PIP_INDEX_URL=${CS_PY_INDEX}"
          echo "UV_PIP_NO_INDEX=1"        # forbid fallback to pypi.org
          echo "UV_PIP_VERBOSE=2"         # log every request
        } >> "$GITHUB_ENV"

    # 3. Install deps (no compile dance needed)
    - name: Install deps with uv
      run: |
        pip install uv
        uv pip install --system --no-cache-dir -r requirements.in

    - name: Run tests
      run: pytest -q
