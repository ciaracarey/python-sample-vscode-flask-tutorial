version: 2.1

jobs:
  build:
    docker: 
      - image: cimg/python:3.10   # CircleCI's official Python image
    environment:
      CS_ORG: globex-innovations
      CS_REPO: acme-prod
      SERVICE: ci_acme_service
      # CLOUDSMITH_API_KEY should be stored securely in CircleCI → Project Settings → Environment Variables
    steps:
      - checkout

      # Upgrade pip
      - run:
          name: Upgrade pip
          command: python -m pip install --upgrade pip

      # Configure PIP_INDEX_URL with Cloudsmith API key
      - run:
          name: Configure pip to use Cloudsmith
          command: |
            echo "export PIP_INDEX_URL=https://token:${CLOUDSMITH_API_KEY}@dl.cloudsmith.io/basic/${CS_ORG}/${CS_REPO}/python/simple/" >> $BASH_ENV
            source $BASH_ENV

      # Install dependencies (including requirements.txt if present)
      - run:
          name: Install dependencies
          command: |
            pip install flake8 pytest
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Run tests
      - run:
          name: Run tests
          command: pytest

workflows:
  build_and_test:
    jobs:
      - build
