# azure-pipelines.yml
trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  CS_ORG: 'globex-innovations'
  CS_REPO: 'acme-nonprod'
  CS_SERVICE_SLUG: 'ci_acme_service'   # Cloudsmith service account slug
  CS_PROVIDER_URL: 'https://vstoken.dev.azure.com/BotConsulting/'  # Issuer you configured in Cloudsmith

steps:
- checkout: self

# (Optional) Show the ADO OIDC provider URL you can call
- bash: |
    echo "System OIDC Provider URL:"
    echo "$(System.OidcRequestUri)"
    echo
    echo "With API version + audience=cloudsmith:"
    echo "$(System.OidcRequestUri)?api-version=7.1&audience=cloudsmith"
  displayName: "Print OIDC provider URL (info)"

# Mint ADO OIDC -> exchange for Cloudsmith token
- bash: |
    set -euo pipefail

    # 1) Mint ADO OIDC token (IMPORTANT: set audience=cloudsmith)
    OIDC_TOKEN=$(curl -s -X POST \
      -H "Authorization: Bearer $(System.AccessToken)" \
      -H "Content-Length: 0" \
      "$(System.OidcRequestUri)?api-version=7.1&audience=cloudsmith" \
      | jq -r '.oidcToken')

    if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ]; then
      echo "Failed to mint ADO OIDC token"; exit 1
    fi

    # (Optional) Inspect key claims (non-secret): iss, aud, sub
    echo "$OIDC_TOKEN" | awk -F. '{print $2}' | base64 -d 2>/dev/null | jq '{iss,aud,sub}'

    # 2) Exchange for Cloudsmith token using your org + service account
    CSM_TOKEN=$(curl -s -X POST \
      -H "Content-Type: application/json" \
      -d "{\"oidc_token\":\"$OIDC_TOKEN\",\"service_slug\":\"$(CS_SERVICE_SLUG)\"}" \
      "https://api.cloudsmith.io/openid/$(CS_ORG)/" \
      | jq -r '.token')

    if [ -z "$CSM_TOKEN" ] || [ "$CSM_TOKEN" = "null" ]; then
      echo "Failed to obtain Cloudsmith token"; exit 1
    fi

    # 3) Export for later steps
    echo "##vso[task.setvariable variable=CLOUDSMITH_API_KEY;issecret=true]$CSM_TOKEN"
  displayName: "Mint Cloudsmith token via ADO OIDC"

# Python example: install from Cloudsmith (Basic auth = <service-slug>:<token>)
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.12'
  displayName: "Use Python 3.12"

- bash: |
    set -euo pipefail
    python -m pip install --upgrade pip
    pip install -r requirements.txt \
      --index-url "https://$(CS_SERVICE_SLUG):$(CLOUDSMITH_API_KEY)@dl.cloudsmith.io/basic/$(CS_ORG)/$(CS_REPO)/python/simple/"
  displayName: "pip install from Cloudsmith"
