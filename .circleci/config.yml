version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.10   # CircleCI's official Python image
    environment:
      CS_WORKSPACE: globex-innovations
      CS_REPO: acme-nonprod
      SERVICE: gha-service
      # CLOUDSMITH_API_KEY should be stored securely in CircleCI → Project Settings → Environment Variables
    steps:
      - checkout

      # Install uv (minimal swap from pip upgrade)
      - run:
          name: Install uv
          command: python -m pip install --upgrade uv

      # Configure index URL for uv/pip
      - run:
          name: Configure uv to use Cloudsmith
          command: |
            echo "export PIP_INDEX_URL=https://token:${CLOUDSMITH_API_KEY}@dl.cloudsmith.io/basic/${CS_WORKSPACE}/${CS_REPO}/python/simple/" >> $BASH_ENV
            source $BASH_ENV

      # Install dependencies (including requirements.txt if present)
      - run:
          name: Install dependencies
          command: |
            uv pip install flake8 pytest
            if [ -f requirements.txt ]; then uv pip install -r requirements.txt; fi

      # Run tests
      - run:
          name: Run tests
          command: pytest

workflows:
  build_and_test:
    jobs:
      - build
