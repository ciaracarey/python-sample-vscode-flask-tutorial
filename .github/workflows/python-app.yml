name: Python CI (uv + Cloudsmith — wheel-only)
 
on:
  push:          { branches: ["main"] }
  pull_request:  { branches: ["main"] }
  workflow_dispatch: {}
 
permissions: 
  contents: read 
  id-token: write               # needed for Cloudsmith OIDC

env: 
  CS_ORG:   globex-innovations
  CS_REPO:  acme-nonprod1 
  SERVICE:  gha-service      # Cloudsmith service-account
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4 

    - uses: actions/setup-python@v5
      with: { python-version: "3.12" }

    # 1. OIDC login – populates $CLOUDSMITH_API_KEY
    - name: Cloudsmith OIDC login
      uses: cloudsmith-io/cloudsmith-cli-action@v1.0.2
      with:
        oidc-namespace:    ${{ env.CS_ORG }}
        oidc-service-slug: ${{ env.SERVICE }}
        oidc-auth-only:    "true"

    # 2. Install uv
    - name: Install uv
      run: |
        python -m pip install --upgrade pip
        pip install uv

    # 3. Configure uv to use Cloudsmith index
    - name: Configure uv index for Cloudsmith
      run: |
        echo "UV_INDEX_URL=https://token:${CLOUDSMITH_API_KEY}@dl.cloudsmith.io/basic/${{ env.CS_ORG }}/${{ env.CS_REPO }}/python/simple/" >> $GITHUB_ENV

    # 3test. Configure uv to use Cloudsmith index for my test
    - name: Configure uv index for Cloudsmith
      env:
         CS_API: ${{ secrets.CS_API_KEY }}
      run: |
        echo "UV_INDEX_URL=https://token:${CS_API}@dl.cloudsmith.io/basic/tenable/ciara-python-test/python/simple/" >> $GITHUB_ENV

    # 4. Install dependencies via uv (so we see the EPM 403s here)
    - name: Install dependencies with uv
      run: |
        if [ -f requirements.txt ]; then
          uv pip install --system -vv -r requirements.txt
        fi

